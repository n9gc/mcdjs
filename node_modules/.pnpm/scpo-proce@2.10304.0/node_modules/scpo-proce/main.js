/**
 * 幻想私社异步过程类
 * @version 2.10304.0
 * @license GPL-3.0-or-later
 * @link https://github.com/E0SelmY4V/scpo-proce
 */
(()=>{function t(t,e){if("function"==typeof t)return new m(t,e);const n=new m(null,null,!0);return n.lastRtn=arguments,n}t.isPipe=!0;const e=t.notModule="undefined"==typeof module,n=t.hasObject_keys="function"==typeof Object?.keys,o=t.errAbled="undefined"==typeof console?"alert":"function"==typeof console?.error?"error":"function"==typeof console?.log?"log":"none",r=t.apply=(t,e)=>{switch(e.length){case 0:return t();case 1:return t(e[0]);case 2:return t(e[0],e[1]);case 3:return t(e[0],e[1],e[2]);default:return t.apply(null,e)}},s=t.isThenable=t=>"function"==typeof t?.then,l=t.isArrayLike=t=>"object"==typeof t&&"number"==typeof t?.length,i=(t.arrayFrom=t=>{const e=[];for(let n=0;n<t.length;n++)e.push(t[n]);return e},t.getList=t=>l(t[0])?t[0]:t);let c=!1,u=-1,h=1;t.getId=()=>(c=!c)?u--:h++;const f=t.forIn=(t,e)=>{for(const n in e)t[n]=e[n]};function a(t){return t?._isProceConfig?t:this.set(t)}a.configAll=t=>f(a.prototype,t),a.prototype={actTrap:!0,errlv:"log",todo:null,ordo:null,_isProceConfig:!0,stopTrap:!1},f(a.prototype,n?{set(t){return f(this,t),this},get(t){const e=new a(t),n=Object.keys(this);if(t)for(let o=n.length-1;o>=0;--o)n[o]in t||(e[n[o]]=this[n[o]]);else for(let t=n.length-1;t>=0;--t)e[n[t]]=this[n[t]];return e}}:{set(t){this._seted||(this._seted=[]);for(const e in t)this._seted.push(e),this[e]=t[e];return this},get(t){const e=new a(t),n=this._seted;if(t)for(let o=n.length-1;o>=0;--o)n[o]in t||(e[n[o]]=this[n[o]],e._seted.push(n[o]));else for(let t=n.length-1;t>=0;--t)e[n[t]]=this[n[t]],e._seted.push(n[t]);return e},_seted:null}),t.ConfigClass=a,t.config=new a;const p=t.doRtn=(t,e,n)=>t.nmArg?e(n):(t.nmArg=!0,r(e,n)),g=t.act=(t,e,n)=>{const o=[t.ftodo,t.fordo];for(let t=0;t<n?.length;t++)o.push(n[t]);try{const n=r(e,o);s(n)&&t.config.actTrap&&n.then(null,t.fordo),t.acted=!0}catch(e){t.acted=!0,t.fordo(e)}},d=t.clear=(t,e)=>{const n=t.queuetodo;let o=t.pointer;for(;++o<n.length;)if("function"==typeof n[o])try{e=p(t,n[o],e)}catch(n){t.pointer=o,e=y(t,n),o=t.pointer}t.lastDef=setTimeout((()=>t.then(t.config.todo,t.config.ordo))),t.lastRtn=e,t.cleared=!0},y=t.exeordo=(t,e)=>{const n=t.queueordo;let o=t.pointer;for(;++o<n.length;)if("function"==typeof n[o]){t.pointer=o;try{return p(t,n[o],e)}catch(e){return y(t,e)}}return t.pointer=o,w(t,t.nmArg?e:e[0]),e},w=t.toss=(t,e)=>{const n=t;n.lastErr=setTimeout((()=>{if(null!==n.lastDef)return w(n,e);switch(n.config.errlv){case"throw":throw e;case"log":switch(o){case"error":console.error("scpo-proce Uncaught",e);case"log":console.log("scpo-proce Uncaught",e);case"alert":try{alert(`scpo-proce Uncaught ${e?.message??e}`)}catch{}}}}))};function m(t,e,n){this.queuetodo=[],this.queueordo=[],this.config=new a(e);const o=this;let r=!0;n?this.cleared=!0:(this.ftodo=(...t)=>r&&(r=!1,d(o,t)),this.fordo=(...t)=>r&&(r=!1,d(o,y(o,t))),"function"==typeof t&&g(this,t))}m.prototype={ftodo:null,fordo:null,queuetodo:null,queueordo:null,cleared:!1,acted:!1,nmArg:!1,lastRtn:[],lastErr:null,lastDef:null,config:null,pointer:-1,then(t,e){if(this.isPipe)return new m(null,null,!0).then(t,e);if(this.cleared){this.pointer++,clearTimeout(this.lastDef),this.lastDef=null;try{null===this.lastErr?"function"==typeof t&&(this.lastRtn=p(this,t,this.lastRtn)):"function"==typeof e&&(clearTimeout(this.lastErr),this.lastErr=null,this.lastRtn=p(this,e,this.lastRtn))}catch(t){w(this,this.lastRtn=t)}}else this.queueordo.push(e),this.queuetodo.push(t);return this},trap(t){return this.then(null,t)},next(t,e,n){const o=new m,r=this.config.get(n);return this.then(((...e)=>(o.config=r,g(o,t,e))),r.stopTrap||o.fordo),"function"==typeof e?o.trap(e):o},take(t,e,n){if(this.isPipe)return new m(null,null,!0).take(t,e,n);"number"==typeof t?n=t:"number"!=typeof n&&(n=-1);const o=this,l=new m(((t,e)=>{const l=(...o)=>s(o[0])&&0!=n--?o[0].then(l,e):r(t,o);o.then(l,e)}));return"function"==typeof t||"function"==typeof e?l.then(t,e):l},grab(t,e,n,o){return this.take(n).next(t,e,o)},conf(t){if(this.isPipe)return new m(null,null,!0).conf(t);const e=this;return this.then((()=>e.config=e.config.get(t)))},configAll(t){return this.then((()=>a.configAll(t)))},todo(){const t=new m(null,null,!0);return t.lastRtn=arguments,t},ordo(){const t=new m(null,null,!0);return w(t,(t.lastRtn=arguments)[0]),t},all(){const t=i(arguments),e=[[]];let n=t.length,o=n;return new m(((l,i)=>{for(;--n>=0;)s(t[n])?(n=>{t[n].then(((...t)=>{let s=t.length;for(;--s>=0;)(e[s]||(e[s]=[]))[n]=t[s];0==--o&&r(l,e)}),i)})(n):(--o,e[0][n]=t[n]);o||r(l,e)}))},one(){const t=i(arguments),e=new m(((n,o)=>{for(let r=0;r<t.length;r++){if(!s(t[r]))return e.acted?void 0:n(t[r]);t[r].then(n,o)}}));return e},snake(){const t=i(arguments);let e=this;return new m(((n,o)=>{for(let n=0;n<t.length;n++)e=e.next(t[n]);e.then(n,o)}))}},m.prototype[["ca","ch"].join("t")]=m.prototype.trap,t.Proce=m;const b=m.prototype,R=["then","trap","next","take","catch","grab","conf","configAll","todo","ordo","snake","all","one"];for(let e=R.length-1;e>=0;--e)t[R[e]]=b[R[e]];e?window.scpoProce=t:module.exports=t})();